{% extends "base.html" %}
{% block content %}
<div id="stockChart" class="app-content">
    <form id="analyzeForm" method="POST" action="/analyze">
        <div class="mb-3">
            <input type="text" class="form-control" id="stockSearch" name="stocks" placeholder="Search companies (max 5, comma-separated)" required value="{{ request.form['stocks'] if request.form['stocks'] else '' }}">
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-primary">Generate Charts</button>
        </div>
    </form>
    {% if chart_img %}
        <div class="row mt-4">
            <div class="col-12 text-center">
                <div style="position: relative;">
                    <img id="chartImage" src="data:image/png;base64,{{ chart_img }}" class="img-fluid">
                    <div style="position: absolute; top: 10px; right: 10px;">
                        <select id="periodSelector">
                            <option value="ytd">YTD</option>
                            <option value="5y">5 Years</option>
                            <option value="10y">10 Years</option>
                            <option value="15y">15 Years</option>
                            <option value="20y">20 Years</option>
                            <option value="25y">25 Years</option>
                        </select>
                        <input type="checkbox" id="logScaleCheckbox"> Log Scale
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<div id="portfolioBuilder" class="app-content" style="display: none;">
    <h2>Portfolio Builder</h2>
    <div id="portfolioInputs">
        <form id="portfolioForm">
            <div id="stockInputs">
            </div>
            <button type="button" id="addStock" class="btn btn-secondary">Add Stock</button>
            <button type="button" id="equalWeights" class="btn btn-info">Equal Weights</button>
            <button type="button" id="calculatePortfolio" class="btn btn-primary">Calculate Portfolio</button>
        </form>
    </div>
    <div id="portfolioResults"></div>
</div>

<script>
    $(document).ready(function() {

        $('#periodSelector, #logScaleCheckbox').on('change', function() {
            var currentStocks = $('#stockSearch').val();
            var period = $('#periodSelector').val();
            var logScale = $('#logScaleCheckbox').is(':checked');

            $.ajax({
                url: '/analyze',
                type: 'POST',
                data: {
                    stocks: currentStocks,
                    period: period,
                    log_scale: logScale
                },
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    $('#chartImage').attr('src', 'data:image/png;base64,' + response.chart_img);
                },
                error: function(error) {
                    console.error("Error:", error);
                }
            });
        });

        let stockCount = 0;

        $('#addStock').click(function() {
            if (stockCount < 10) {
                stockCount++;
                $('#stockInputs').append(`
                    <div class="mb-3">
                        <label for="stock${stockCount}" class="form-label">Stock ${stockCount}:</label>
                        <input type="text" class="form-control stock-input" id="stock${stockCount}" name="stock${stockCount}" placeholder="Stock ${stockCount}">
                        <div class="slider-container">
                            <div id="slider${stockCount}" class="slider"></div>
                            <input type="hidden" id="allocation${stockCount}" name="allocation${stockCount}" value="0">
                            <span id="sliderValue${stockCount}">0%</span>
                        </div>
                    </div>
                `);
                setupSlider(stockCount);
                setupAutocomplete(`#stock${stockCount}`);
            }
        });

        function setupSlider(index) {
            $(`#slider${index}`).slider({
                min: 0,
                max: 100,
                slide: function(event, ui) {
                    $(`#allocation${index}`).val(ui.value);
                    $(`#sliderValue${index}`).text(ui.value + '%');
                }
            });
        }

        function setupAutocomplete(inputId) {
            $(inputId).on("input", function() {
                let inputVal = $(this).val();
                let lastCommaIndex = inputVal.lastIndexOf(",");
                let currentTerm;

                if (lastCommaIndex !== -1) {
                    currentTerm = inputVal.substring(lastCommaIndex + 1).trim();
                } else {
                    currentTerm = inputVal;
                }

                $(this).autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "/search",
                            dataType: "json",
                            data: { term: currentTerm },
                            success: function(data) {
                                response(data);
                            }
                        });
                    },
                    select: function(event, ui) {
                        $(inputId).val(ui.item.value);
                        return false;
                    }
                });
            }
        }

        $('#equalWeights').click(function() {
            let numStocks = $('.stock-input').length;
            let equalWeight = Math.round(100 / numStocks);

            $('.slider').each(function(index) {
                $(this).slider('value', equalWeight);
                $(`#allocation${index + 1}`).val(equalWeight);
                $(`#sliderValue${index + 1}`).text(equalWeight + '%');
            });
        });

        $('#calculatePortfolio').click(function() {
            $.ajax({
                url: '/portfolio/calculate',
                type: 'POST',
                data: $('#portfolioForm').serialize(),
                success: function(response) {
                    $('#portfolioResults').html(JSON.stringify(response));
                },
                error: function(error) {
                    console.error("Error:", error);
                }
            });
        });
    });
</script>
<style>
    .slider-container {
        display: flex;
        align-items: center;
    }
    .slider {
        width: 200px;
        margin-right: 10px;
    }
</style>
{% endblock %}